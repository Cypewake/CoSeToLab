<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>聊天室 - {{ username }}</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #0f0f0f, #1a0000);
      color: #eee;
      padding: 20px;
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      color: #ff4d4d;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 80vh;
      border-radius: 10px;
      overflow: hidden;
      background-color: #1e1e1e;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.2);
    }
    .message-list {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }
    .message {
      display: flex;
      margin-bottom: 15px;
      position: relative;
    }
    .message.you { flex-direction: row-reverse; }
    .message-content {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 10px;
      position: relative;
      animation: fadeIn 0.3s;
      word-break: break-word;
    }
    .message.you .message-content {
      background-color: #ff4d4d;
      color: #fff;
      border-bottom-right-radius: 0;
    }
    .message.other .message-content {
      background-color: #333;
      color: #eee;
      border-bottom-left-radius: 0;
    }
    .avatar {
      width: 35px;
      height: 35px;
      background-color: #990000;
      color: white;
      font-weight: bold;
      font-size: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 10px;
      user-select: none;
    }
    .message-header {
      font-size: 11px;
      color: #bbb;
      margin-bottom: 5px;
    }
    .message-content:hover::after {
      content: "右键撤回";
      position: absolute;
      top: -18px;
      right: 5px;
      font-size: 10px;
      color: #ffcccc;
    }
    .input-area {
      display: flex;
      flex-direction: column;
      padding: 10px;
      border-top: 1px solid #333;
      background: #121212;
    }
    .input-row {
      display: flex;
      margin-top: 5px;
      align-items: center;
    }
    .input-area textarea {
      flex: 1;
      height: 60px;
      resize: none;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      background: #1a1a1a;
      color: #eee;
      border: 1px solid #555;
      outline: none;
      transition: border-color 0.3s;
    }
    .input-area textarea.dragover {
      border-color: #ff4d4d;
      background-color: #2b0000;
    }
    .input-area button, .input-area input[type="file"] {
      margin-left: 10px;
      padding: 0 20px;
      border: none;
      background-color: #ff1a1a;
      color: white;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
      user-select: none;
      transition: all 0.2s ease;
    }
    /* 添加按钮悬停效果 */
    .input-area button:hover {
      background-color: #ff5e5e;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
    }
    /* 添加按钮点击效果 */
    .input-area button:active, .input-area button.clicked {
      background-color: #ff3a3a;
      transform: scale(0.98);
    }
    /* 添加按钮焦点效果 */
    .input-area button:focus {
      outline: none;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
    }
    /* 添加按钮禁用效果 */
    .input-area button:disabled {
      background-color: #555;
      box-shadow: none;
      cursor: not-allowed;
    }
    #progressBar {
      width: 100%;
      height: 6px;
      background-color: #333;
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
      display: none;
    }
    #progressBarInner {
      height: 100%;
      width: 0;
      background-color: #ff4d4d;
      transition: width 0.2s;
    }
    img.preview-image {
      max-width: 100px;
      max-height: 80px;
      margin-left: 10px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.3s;
    }
    img.preview-image:hover {
      border-color: #ff4d4d;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <h2>🔥Daybreak聊天室</h2>
    <div>
      欢迎, {{ username }} | <a href="{{ url_for('logout') }}" style="color: #ff4d4d;">退出</a>
    </div>
  </div>

  <div class="chat-container">
    <div class="message-list" id="messageList"></div>
    <div class="input-area" id="inputArea">
      <textarea id="messageInput" placeholder="说点什么吧..."></textarea>
      <div class="input-row">
        <input type="file" id="fileInput" accept="image/*,application/pdf,.doc,.docx,.txt,.zip,.rar" />
        <button id="sendMessageBtn">发送</button>
      </div>
      <div id="progressBar"><div id="progressBarInner"></div></div>
      <div id="imagePreviewContainer"></div>
    </div>
  </div>

  <script>
    const username = "{{ username }}";
    const messageList = document.getElementById('messageList');
    const messageInput = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const progressBar = document.getElementById('progressBar');
    const progressBarInner = document.getElementById('progressBarInner');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const inputArea = document.getElementById('inputArea');

    // 拖拽样式反馈
    messageInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      messageInput.classList.add('dragover');
    });
    messageInput.addEventListener('dragleave', (e) => {
      e.preventDefault();
      messageInput.classList.remove('dragover');
    });
    messageInput.addEventListener('drop', (e) => {
      e.preventDefault();
      messageInput.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length) {
        handleFileUpload(files[0]);
      }
    });

    // 选择文件预览
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) {
        handleFilePreview(fileInput.files[0]);
      } else {
        clearImagePreview();
      }
    });

    // 文件预览逻辑
    function handleFilePreview(file) {
      clearImagePreview();
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'preview-image';
          img.title = file.name;
          img.onclick = () => {
            if (confirm('确定取消当前图片选择吗？')) {
              fileInput.value = '';
              clearImagePreview();
            }
          };
          imagePreviewContainer.appendChild(img);
        };
        reader.readAsDataURL(file);
      } else {
        // 不是图片，显示文件名
        const fileNameDiv = document.createElement('div');
        fileNameDiv.style.color = '#ff4d4d';
        fileNameDiv.textContent = `已选择文件: ${file.name} (非图片)`;
        imagePreviewContainer.appendChild(fileNameDiv);
      }
    }

    function clearImagePreview() {
      imagePreviewContainer.innerHTML = '';
    }

    // 发送消息，支持文件上传和文本发送
    sendMessageBtn.addEventListener('click', () => {
      // 添加按钮点击效果
      sendMessageBtn.classList.add('clicked');
      setTimeout(() => {
        sendMessageBtn.classList.remove('clicked');
      }, 200);

      const content = messageInput.value.trim();
      const file = fileInput.files[0];
      if (file) {
        handleFileUpload(file);
      } else if (content) {
        sendMessage(content);
      }
    });

    function handleFileUpload(file) {
      progressBar.style.display = 'block';
      progressBarInner.style.width = '0%';

      const formData = new FormData();
      formData.append('file', file);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/upload_file', true);

      xhr.upload.onprogress = function (e) {
        if (e.lengthComputable) {
          const percentComplete = (e.loaded / e.total) * 100;
          progressBarInner.style.width = percentComplete + '%';
        }
      };

      xhr.onload = function () {
        if (xhr.status === 200) {
          progressBarInner.style.width = '100%';
          progressBar.style.display = 'none';
          try {
            const res = JSON.parse(xhr.responseText);
            if (res.url) {
              sendMessage(`<a href="${res.url}" target="_blank">📎 文件: ${file.name}</a>`);
              fileInput.value = '';
              clearImagePreview();
            } else {
              alert('上传失败，未获取文件链接');
            }
          } catch (e) {
            alert('上传失败，服务器返回异常');
          }
        } else {
          progressBar.style.display = 'none';
          alert('上传失败，HTTP状态：' + xhr.status);
        }
      };

      xhr.onerror = function () {
        progressBar.style.display = 'none';
        alert('上传失败，网络错误');
      };

      xhr.send(formData);
    }

    function sendMessage(content) {
      fetch('/send_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'content=' + encodeURIComponent(content)
      }).then(res => res.json()).then(data => {
        if (data.message === '消息发送成功') {
          messageInput.value = '';
          fileInput.value = null;
          clearImagePreview();
          loadMessages();
        } else {
          alert('发送消息失败');
        }
      }).catch(() => alert('网络错误'));
    }

    // 加载消息
    function loadMessages() {
      fetch('/messages')
        .then(res => res.json())
        .then(messages => {
          messageList.innerHTML = '';
          messages.forEach(msg => {
            const isYou = msg.username === username;
            const div = document.createElement('div');
            div.className = 'message ' + (isYou ? 'you' : 'other');
            div.setAttribute('data-id', msg.id);

            // 解析消息内容，如果是图片链接，则展示图片
            let contentHTML = msg.content;
            // 简单检测是否是上传的图片链接
            const imgRegex = /<a href="([^"]+\.(png|jpg|jpeg|gif|bmp))"[^>]*>.*<\/a>/i;
            const match = contentHTML.match(imgRegex);
            if (match) {
              contentHTML = `<a href="${match[1]}" target="_blank"><img src="${match[1]}" style="max-width:150px;max-height:100px;border-radius:8px;" alt="图片"></a>`;
            }

            div.innerHTML = `
              <div class="avatar">${getInitials(msg.username)}</div>
              <div class="message-content">
                <div class="message-header">${msg.username} - ${msg.timestamp}</div>
                <div class="text">${contentHTML}</div>
              </div>
            `;

            div.addEventListener('contextmenu', (e) => {
              e.preventDefault();
              if (isYou && confirm('确定要撤回这条消息吗？')) {
                fetch('/recall_message/' + msg.id, { method: 'POST' })
                  .then(res => res.json())
                  .then(data => {
                    if (data.message === '消息已撤回') loadMessages();
                    else alert(data.error || '撤回失败');
                  });
              }
            });

            messageList.appendChild(div);
          });
          messageList.scrollTop = messageList.scrollHeight;
        });
    }

    // 获取昵称首字母
    function getInitials(name) {
      return name ? name.charAt(0).toUpperCase() : "?";
    }

    // Enter键发送，Shift+Enter换行
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessageBtn.click();
      }
    });

    window.onload = loadMessages;
    //setInterval(loadMessages, 3000);
  </script>
</body>
</html>