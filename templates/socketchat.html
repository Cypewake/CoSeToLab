<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>èŠå¤©å®¤ - {{ username }}</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #0f0f0f, #1a0000);
      color: #eee;
      padding: 20px;
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      color: #ff4d4d;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 80vh;
      border-radius: 10px;
      overflow: hidden;
      background-color: #1e1e1e;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.2);
    }
    .message-list {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }
    .message {
      display: flex;
      margin-bottom: 15px;
      position: relative;
    }
    .message.you { flex-direction: row-reverse; }
    .message-content {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 10px;
      position: relative;
      animation: fadeIn 0.3s;
      word-break: break-word;
    }
    .message.you .message-content {
      background-color: #ff4d4d;
      color: #fff;
      border-bottom-right-radius: 0;
    }
    .message.other .message-content {
      background-color: #333;
      color: #eee;
      border-bottom-left-radius: 0;
    }
    .avatar {
      width: 35px;
      height: 35px;
      background-color: #990000;
      color: white;
      font-weight: bold;
      font-size: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 10px;
      user-select: none;
    }
    .message-header {
      font-size: 11px;
      color: #bbb;
      margin-bottom: 5px;
    }
    .message-content:hover::after {
      content: "å³é”®æ’¤å›";
      position: absolute;
      top: -18px;
      right: 5px;
      font-size: 10px;
      color: #ffcccc;
    }
    .input-area {
      display: flex;
      flex-direction: column;
      padding: 10px;
      border-top: 1px solid #333;
      background: #121212;
    }
    .input-row {
      display: flex;
      margin-top: 5px;
      align-items: center;
    }
    .input-area textarea {
      flex: 1;
      height: 60px;
      resize: none;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      background: #1a1a1a;
      color: #eee;
      border: 1px solid #555;
      outline: none;
      transition: border-color 0.3s;
    }
    .input-area textarea.dragover {
      border-color: #ff4d4d;
      background-color: #2b0000;
    }
    .input-area button, .input-area input[type="file"] {
      margin-left: 10px;
      padding: 0 20px;
      border: none;
      background-color: #ff1a1a;
      color: white;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
      user-select: none;
    }
    #progressBar {
      width: 100%;
      height: 6px;
      background-color: #333;
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
      display: none;
    }
    #progressBarInner {
      height: 100%;
      width: 0;
      background-color: #ff4d4d;
      transition: width 0.2s;
    }
    img.preview-image {
      max-width: 100px;
      max-height: 80px;
      margin-left: 10px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.3s;
    }
    img.preview-image:hover {
      border-color: #ff4d4d;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <h2>ğŸ”¥ DaybreakèŠå¤©å®¤</h2>
    <div>
      æ¬¢è¿, {{ username }} | <a href="{{ url_for('logout') }}" style="color: #ff4d4d;">é€€å‡º</a>
    </div>
  </div>

  <div class="chat-container">
    <div class="message-list" id="messageList"></div>
    <div class="input-area" id="inputArea">
      <textarea id="messageInput" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..."></textarea>
      <div class="input-row">
        <input type="file" id="fileInput" accept="image/*,application/pdf,.doc,.docx,.txt,.zip,.rar" />
        <button id="sendMessageBtn">å‘é€</button>
        <button id="clearContextBtn" style="background:#cc0000; margin-left: 10px;">æ¸…ç†æœºå™¨äººå¯¹è¯</button>
      </div>
      <div id="progressBar"><div id="progressBarInner"></div></div>
      <div id="imagePreviewContainer"></div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const username = "{{ username }}";
    const messageList = document.getElementById('messageList');
    const messageInput = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const clearContextBtn = document.getElementById('clearContextBtn');
    const progressBar = document.getElementById('progressBar');
    const progressBarInner = document.getElementById('progressBarInner');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');

    // ç¡®ä¿ç”¨æˆ·å·²ç™»å½•
    if (!username) {
        window.location.href = '/login';
    }

    // è¿æ¥ Socket.IO
    const socket = io('http://localhost:5000', {
        withCredentials: true  // å…è®¸å‘é€ Cookie
    });

    // è¿æ¥æˆåŠŸäº‹ä»¶
    socket.on('connect', () => {
        console.log('å·²è¿æ¥æœåŠ¡å™¨');
    });

    // è¿æ¥é”™è¯¯äº‹ä»¶
    socket.on('connect_error', (err) => {
        console.error('è¿æ¥é”™è¯¯:', err);
    });

    // æ–­å¼€è¿æ¥äº‹ä»¶
    socket.on('disconnect', () => {
        console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
    });

    // ç›‘å¬æ–°æ¶ˆæ¯äº‹ä»¶
    socket.on('new_message', (data) => {
        addMessageToList(data);
    });

    // ç›‘å¬ç”¨æˆ·è¿æ¥äº‹ä»¶
    socket.on('user_connected', (data) => {
        console.log(`${data.username} ä¸Šçº¿äº†`);
    });

    // ç›‘å¬ç”¨æˆ·æ–­å¼€äº‹ä»¶
    socket.on('user_disconnected', (data) => {
        console.log(`${data.username} ç¦»çº¿äº†`);
    });

    // ç›‘å¬é”™è¯¯äº‹ä»¶
    socket.on('error', (data) => {
        alert('é”™è¯¯: ' + data.msg);
    });

    // ç›‘å¬æ¶ˆæ¯æ’¤å›äº‹ä»¶
    socket.on('message_recalled', (data) => {
        const msgDiv = document.querySelector(`.message[data-id="${data.msg_id}"]`);
        if (msgDiv) {
            msgDiv.querySelector('.message-content').innerHTML = '<i>è¯¥æ¶ˆæ¯å·²è¢«æ’¤å›</i>';
        }
    });

    // ç›‘å¬æœºå™¨äººä¸Šä¸‹æ–‡æ¸…ç†åé¦ˆ
    socket.on('context_cleared', (data) => {
        alert(data.message);
    });

    // æ‹–æ‹½æ ·å¼åé¦ˆ
    messageInput.addEventListener('dragover', (e) => {
        e.preventDefault();
        messageInput.classList.add('dragover');
    });
    messageInput.addEventListener('dragleave', (e) => {
        e.preventDefault();
        messageInput.classList.remove('dragover');
    });
    messageInput.addEventListener('drop', (e) => {
        e.preventDefault();
        messageInput.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length) {
            handleFileUpload(files[0]);
        }
    });

    // é€‰æ‹©æ–‡ä»¶é¢„è§ˆ
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length) {
            handleFilePreview(fileInput.files[0]);
        } else {
            clearImagePreview();
        }
    });

    // æ–‡ä»¶é¢„è§ˆé€»è¾‘
    function handleFilePreview(file) {
        clearImagePreview();
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'preview-image';
                img.title = file.name;
                img.onclick = () => {
                    if (confirm('ç¡®å®šå–æ¶ˆå½“å‰å›¾ç‰‡é€‰æ‹©å—ï¼Ÿ')) {
                        fileInput.value = '';
                        clearImagePreview();
                    }
                };
                imagePreviewContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        } else {
            const fileNameDiv = document.createElement('div');
            fileNameDiv.style.color = '#ff4d4d';
            fileNameDiv.textContent = `å·²é€‰æ‹©æ–‡ä»¶: ${file.name} (éå›¾ç‰‡)`;
            imagePreviewContainer.appendChild(fileNameDiv);
        }
    }

    function clearImagePreview() {
        imagePreviewContainer.innerHTML = '';
    }

    // å‘é€æ¶ˆæ¯ï¼ˆæ–‡æœ¬æˆ–æ–‡ä»¶é“¾æ¥ï¼‰
    sendMessageBtn.addEventListener('click', () => {
        const content = messageInput.value.trim();
        const file = fileInput.files[0];
        if (file) {
            handleFileUpload(file);
        } else if (content) {
            sendMessage(content);
        }
    });

    // å‘é€æ–‡æœ¬æ¶ˆæ¯å‡½æ•°
    function sendMessage(content) {
        socket.emit('send_message', { content: content });
        messageInput.value = '';
        fileInput.value = null;
        clearImagePreview();
    }

    // æ–‡ä»¶ä¸Šä¼ å‡½æ•°
    function handleFileUpload(file) {
        progressBar.style.display = 'block';
        progressBarInner.style.width = '0%';

        const formData = new FormData();
        formData.append('file', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/upload_file', true);

        xhr.upload.onprogress = function (e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBarInner.style.width = percentComplete + '%';
            }
        };

        xhr.onload = function () {
            progressBar.style.display = 'none';
            if (xhr.status === 200) {
                try {
                    const res = JSON.parse(xhr.responseText);
                    if (res.url) {
                        sendMessage(`<a href="${res.url}" target="_blank">ğŸ“ æ–‡ä»¶: ${file.name}</a>`);
                    } else {
                        alert('ä¸Šä¼ å¤±è´¥ï¼Œæœªè·å–æ–‡ä»¶é“¾æ¥');
                    }
                } catch (e) {
                    alert('ä¸Šä¼ å¤±è´¥ï¼ŒæœåŠ¡å™¨è¿”å›å¼‚å¸¸');
                }
            } else {
                alert('ä¸Šä¼ å¤±è´¥ï¼ŒHTTPçŠ¶æ€ï¼š' + xhr.status);
            }
        };

        xhr.onerror = function () {
            progressBar.style.display = 'none';
            alert('ä¸Šä¼ å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯');
        };

        xhr.send(formData);
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°æ¶ˆæ¯åˆ—è¡¨
    function addMessageToList(msg) {
        const isYou = msg.username === username;

        // åˆ›å»ºæ¶ˆæ¯å¤–å±‚div
        const div = document.createElement('div');
        div.className = 'message ' + (isYou ? 'you' : 'other');
        div.setAttribute('data-id', msg.id || '');

        // è§£æå†…å®¹ï¼Œæ”¯æŒXSSæ¼æ´æ¼”ç¤ºï¼ˆç›´æ¥ innerHTMLï¼‰
        let contentHTML = msg.content;

        // å¦‚æœå†…å®¹æ˜¯æ–‡ä»¶é“¾æ¥ï¼Œåˆ™å°è¯•ç”¨imgæ ‡ç­¾å±•ç¤º
        const imgRegex = /<a href="([^"]+\.(png|jpg|jpeg|gif|bmp))"[^>]*>.*<\/a>/i;
        const match = contentHTML.match(imgRegex);
        if (match) {
            contentHTML = `<a href="${match[1]}" target="_blank"><img src="${match[1]}" style="max-width:150px;max-height:100px;border-radius:8px;" alt="å›¾ç‰‡"></a>`;
        }

        div.innerHTML = `
            <div class="avatar">${getInitials(msg.username)}</div>
            <div class="message-content">
                <div class="message-header">${msg.username} - ${formatTimestamp(msg.timestamp)}</div>
                <div class="text">${contentHTML}</div>
            </div>
        `;

        // ç»‘å®šå³é”®æ’¤å›äº‹ä»¶ï¼ˆä»…è‡ªå·±æ¶ˆæ¯å¯æ’¤å›ï¼‰
        if (isYou && msg.id) {
            div.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (confirm('ç¡®å®šè¦æ’¤å›è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                    socket.emit('recall_message', { msg_id: msg.id });
                }
            });
        }

        messageList.appendChild(div);
        messageList.scrollTop = messageList.scrollHeight;
    }

    // æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
    function formatTimestamp(ts) {
        if (!ts) return '';
        const d = new Date(ts);
        return d.toLocaleString();
    }

    // è·å–æ˜µç§°é¦–å­—æ¯
    function getInitials(name) {
        return name ? name.charAt(0).toUpperCase() : "?";
    }

    // æŒ‰Enterå‘é€æ¶ˆæ¯ï¼ŒShift+Enteræ¢è¡Œ
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessageBtn.click();
        }
    });

    // æ¸…ç†æœºå™¨äººå¯¹è¯ä¸Šä¸‹æ–‡æŒ‰é’®
    clearContextBtn.addEventListener('click', () => {
        socket.emit('clear_context');
    });

    // é¡µé¢åŠ è½½å®Œæ¯•ååˆå§‹åŒ–
    window.onload = () => {
        // åŠ è½½å†å²æ¶ˆæ¯
        fetch('/messages')
            .then(res => res.json())
            .then(messages => {
                messageList.innerHTML = '';
                messages.forEach(msg => {
                    addMessageToList(msg);
                });
            });
    };
  </script>
</body>
</html>